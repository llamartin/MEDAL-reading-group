<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MEDAL Reading Group — Presentation Sign-Up</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1a18;
    --cream: #f7f4ee;
    --sage: #5a7260;
    --sage-light: #8aaa94;
    --gold: #b08d57;
    --gold-light: #d4b483;
    --rule: #d4cfc4;
    --selected-bg: #edf2ee;
    --selected-border: #5a7260;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--cream);
    color: var(--ink);
    font-family: 'Cormorant Garamond', Georgia, serif;
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  .page {
    max-width: 900px;
    margin: 0 auto;
    padding: 64px 48px 80px;
    position: relative;
    z-index: 1;
  }

  .header {
    border-bottom: 1px solid var(--ink);
    padding-bottom: 32px;
    margin-bottom: 40px;
    animation: fadeDown 0.6s ease both;
  }

  .lab-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--sage);
    margin-bottom: 16px;
  }

  h1 {
    font-size: clamp(2rem, 4vw, 3rem);
    font-weight: 300;
    line-height: 1.1;
    letter-spacing: -0.01em;
    margin-bottom: 12px;
  }

  h1 em { font-style: italic; color: var(--gold); }

  .subtitle {
    font-size: 1rem;
    font-weight: 300;
    color: #555;
    font-style: italic;
    line-height: 1.6;
    max-width: 560px;
    margin-top: 8px;
  }

  .instructions {
    background: white;
    border: 1px solid var(--rule);
    border-left: 3px solid var(--sage);
    padding: 20px 24px;
    margin-bottom: 40px;
    animation: fadeDown 0.6s 0.1s ease both;
  }

  .instructions p { font-size: 1rem; line-height: 1.7; font-weight: 300; }
  .instructions p + p { margin-top: 8px; }
  .instructions strong { font-weight: 600; }

  /* Loading overlay */
  .loading-bar {
    height: 2px;
    background: var(--rule);
    width: 100%;
    margin-bottom: 32px;
    overflow: hidden;
    animation: fadeDown 0.4s ease both;
  }

  .loading-bar-fill {
    height: 2px;
    background: var(--sage);
    width: 30%;
    animation: slide 1.2s ease-in-out infinite;
  }

  @keyframes slide {
    0%   { transform: translateX(-100%); }
    100% { transform: translateX(400%); }
  }

  .name-section {
    margin-bottom: 36px;
    animation: fadeDown 0.6s 0.15s ease both;
  }

  .field-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--sage);
    display: block;
    margin-bottom: 8px;
  }

  .field-input {
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 1.05rem;
    font-weight: 300;
    border: 1px solid var(--rule);
    border-bottom: 1px solid var(--ink);
    background: white;
    padding: 10px 14px;
    width: 320px;
    max-width: 100%;
    outline: none;
    transition: border-color 0.2s;
    color: var(--ink);
  }

  .field-input:focus { border-color: var(--sage); }

  .section-header {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--sage-light);
    margin: 40px 0 16px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .section-header::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--rule);
  }

  .progress-bar-wrap {
    margin-bottom: 28px;
    animation: fadeDown 0.5s 0.2s ease both;
  }

  .progress-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--sage);
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
  }

  .progress-track { height: 3px; background: var(--rule); width: 100%; }
  .progress-fill { height: 3px; background: var(--sage); transition: width 0.4s ease; width: 0%; }

  /* Paper cards */
  .paper-card {
    border: 1px solid var(--rule);
    background: white;
    margin-bottom: 10px;
    animation: fadeUp 0.4s ease both;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .paper-card.claimed-mine  { border-color: var(--sage); background: var(--selected-bg); }
  .paper-card.claimed-other { opacity: 0.72; }

  .paper-card-bar {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--sage);
    transform: scaleY(0);
    transform-origin: bottom;
    transition: transform 0.25s ease;
  }

  .paper-card.claimed-mine .paper-card-bar { transform: scaleY(1); }

  .paper-inner {
    padding: 16px 20px 16px 24px;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 16px;
    align-items: start;
  }

  .paper-title { font-size: 1.05rem; font-weight: 400; line-height: 1.4; margin-bottom: 3px; }

  .paper-tag {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    letter-spacing: 0.1em;
    color: var(--sage-light);
    text-transform: uppercase;
  }

  .paper-presenter { font-size: 0.9rem; font-style: italic; color: var(--sage); margin-top: 6px; }
  .paper-presenter.empty { color: #bbb; }

  .paper-actions { display: flex; align-items: flex-start; gap: 8px; flex-shrink: 0; margin-top: 2px; }

  .btn-claim {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    background: none;
    border: 1px solid var(--sage);
    color: var(--sage);
    padding: 5px 14px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-claim:hover:not(:disabled) { background: var(--sage); color: white; }
  .btn-claim:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-release {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    background: none;
    border: 1px solid var(--rule);
    color: #aaa;
    padding: 5px 12px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-release:hover { border-color: #e07070; color: #e07070; }

  /* Availability picker */
  .avail-section {
    border-top: 1px solid var(--rule);
    padding: 16px 24px 20px;
    display: none;
  }

  .avail-section.open { display: block; }

  .avail-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--sage);
    margin-bottom: 14px;
  }

  .avail-months { display: flex; flex-wrap: wrap; gap: 20px; }
  .avail-month { min-width: 140px; }

  .month-name {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--sage-light);
    margin-bottom: 6px;
  }

  .date-chips { display: flex; flex-wrap: wrap; gap: 5px; }

  .date-chip {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.05em;
    padding: 4px 10px;
    border: 1px solid var(--rule);
    cursor: pointer;
    transition: all 0.15s;
    background: white;
    color: #666;
    user-select: none;
  }

  .date-chip:hover { border-color: var(--sage); color: var(--sage); }
  .date-chip.on { background: var(--sage); border-color: var(--sage); color: white; }

  .avail-counter {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--sage-light);
    margin-top: 12px;
  }

  .avail-counter span { color: var(--sage); }

  /* Submit */
  .submit-area {
    margin-top: 48px;
    padding-top: 32px;
    border-top: 1px solid var(--rule);
    animation: fadeUp 0.5s 0.3s ease both;
  }

  .btn-submit {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    background: var(--ink);
    color: var(--cream);
    border: none;
    padding: 14px 36px;
    cursor: pointer;
    transition: background 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 10px;
  }

  .btn-submit:hover:not(:disabled) { background: var(--sage); }
  .btn-submit:disabled { opacity: 0.35; cursor: not-allowed; }

  .submit-note {
    font-size: 0.95rem;
    font-weight: 300;
    font-style: italic;
    color: #888;
    margin-top: 12px;
    line-height: 1.5;
  }

  /* Info panels */
  .panel {
    margin-top: 32px;
    padding: 24px;
    display: none;
  }

  .panel h3 { font-weight: 300; font-size: 1.2rem; margin-bottom: 8px; letter-spacing: -0.01em; }
  .panel p  { font-size: 0.95rem; font-weight: 300; font-style: italic; color: #666; line-height: 1.6; }

  .panel-waiting {
    background: white;
    border: 1px solid var(--rule);
    border-left: 3px solid var(--gold);
  }

  .panel-schedule {
    background: var(--selected-bg);
    border: 1px solid var(--selected-border);
  }

  .panel-schedule h3 { margin-bottom: 4px; }
  .panel-schedule .sub { font-size: 0.9rem; font-style: italic; color: #777; margin-bottom: 20px; font-weight: 300; }

  .panel-error {
    background: #fff8f0;
    border: 1px solid var(--gold-light);
    border-left: 3px solid var(--gold);
  }

  .panel-error p { color: #7a5c30; }

  .schedule-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 10px 0;
    border-bottom: 1px solid var(--rule);
    gap: 16px;
  }

  .schedule-row:last-child { border-bottom: none; }
  .schedule-paper-title    { font-size: 1rem; font-weight: 400; }
  .schedule-presenter      { font-size: 0.85rem; font-style: italic; color: var(--sage); }

  .schedule-date {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--sage);
    white-space: nowrap;
    flex-shrink: 0;
  }

  /* Error toast */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: #3a1a1a;
    color: #fde;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.08em;
    padding: 12px 24px;
    border-radius: 2px;
    transition: transform 0.3s ease;
    z-index: 100;
    white-space: nowrap;
    max-width: 90vw;
    text-align: center;
  }

  .toast.visible { transform: translateX(-50%) translateY(0); }

  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 600px) {
    .page { padding: 36px 20px 60px; }
    .avail-months { gap: 16px; }
  }
</style>
</head>
<body>
<div class="page">

  <div class="header">
    <div class="lab-label">MEDAL · University of Melbourne</div>
    <h1>Reading Group <em>2026</em><br>Presentation Sign-Up</h1>
    <p class="subtitle">Claim a paper and mark every Monday you are available to present. Dates will be assigned once all ten papers are claimed.</p>
  </div>

  <div class="instructions">
    <p><strong>Step 1.</strong> Enter your name, then click <em>Claim</em> on the paper you would like to present.</p>
    <p><strong>Step 2.</strong> Mark every Monday you would be available — select as many as you like. More availability makes it easier to find a schedule that works for everyone.</p>
    <p><strong>Step 3.</strong> Click <em>Submit Availability</em>. Once all ten papers are claimed and everyone has submitted, a schedule will be computed and emailed to the organiser.</p>
  </div>

  <!-- Loading bar shown while fetching initial state -->
  <div class="loading-bar" id="loading-bar">
    <div class="loading-bar-fill"></div>
  </div>

  <div id="main-content" style="display:none">

    <div class="name-section">
      <label class="field-label" for="myname">Your name</label>
      <input class="field-input" type="text" id="myname" placeholder="Enter your name to get started">
    </div>

    <div class="progress-bar-wrap">
      <div class="progress-label">
        <span>Papers claimed</span>
        <span id="progress-count">0 / 10</span>
      </div>
      <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
    </div>

    <div class="section-header">Papers</div>
    <div id="paper-list"></div>

    <div class="submit-area">
      <button class="btn-submit" id="btn-submit" onclick="submitAvailability()" disabled>
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M2 7h10M7 2l5 5-5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Submit Availability
      </button>
      <p class="submit-note" id="submit-note">Claim a paper and mark your available dates first.</p>
    </div>

    <div class="panel panel-waiting" id="panel-waiting">
      <h3>Availability submitted — thank you.</h3>
      <p>Waiting for the rest of the group. Once all ten papers are claimed and submitted, a schedule will be computed and sent to the organiser.</p>
    </div>

    <div class="panel panel-schedule" id="panel-schedule">
      <h3>Schedule computed.</h3>
      <p class="sub">A feasible assignment was found based on everyone's availability.</p>
      <div id="schedule-rows"></div>
    </div>

    <div class="panel panel-error" id="panel-error">
      <h3>No feasible schedule found.</h3>
      <p>The current availability sets don't allow a conflict-free schedule. Please coordinate directly or ask participants to mark additional dates.</p>
    </div>

  </div><!-- /main-content -->

</div><!-- /page -->

<div class="toast" id="toast"></div>

<script>
// ── CONFIG — paste your Apps Script deployment URL here ──────────────────────
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx9nGtGzqngqMl4-kVEv711G4SnnN98tOkQy60jiCeTypUzf7jOS-sL-PavMLWEfr-f/exec';   // ← replace after deploying

// ── Paper definitions ─────────────────────────────────────────────────────────
const PAPERS = [
  { id: 1,  title: "Can Pollution Markets Work in Developing Countries?",                                tag: "Environmental Markets" },
  { id: 2,  title: "The Geographical Leakage of Environmental Regulation",                              tag: "Regulation & Leakage" },
  { id: 3,  title: "The Value of Clean Water: Experimental Evidence from Rural India",                  tag: "Water & Development" },
  { id: 4,  title: "Downwind and Out: Strategic Dispersion of Power Plants and Their Pollution",        tag: "Air Quality & Strategy" },
  { id: 5,  title: "Machine Learning Predicts Which Waters the Clean Water Act Regulates",              tag: "ML & Environmental Law" },
  { id: 6,  title: "AI in Charge: Large-Scale Experimental Evidence on EV Charging Demand",            tag: "Energy & AI" },
  { id: 7,  title: "Regulating Untaxable Externalities: Are Vehicle Air Pollution Standards Effective?", tag: "Transport & Regulation" },
  { id: 8,  title: "Who Bears the Burden of Climate Inaction?",                                        tag: "Equity & Climate" },
  { id: 9,  title: "Power Flows: Transmission Lines, Allocative Efficiency, and Corporate Profits",    tag: "Energy Markets" },
  { id: 10, title: "Choosing Who Chooses: Selection-Driven Targeting in Energy Rebate Programs",       tag: "Energy Policy" },
];

const MONTHS = [
  { label: "March", dates: ["Mar 2","Mar 9","Mar 16","Mar 23","Mar 30"] },
  { label: "April", dates: ["Apr 6","Apr 13","Apr 20","Apr 27"] },
  { label: "May",   dates: ["May 4","May 11","May 18","May 25"] },
  { label: "June",  dates: ["Jun 1","Jun 8","Jun 15","Jun 22","Jun 29"] },
];

const ALL_DATES = MONTHS.flatMap(m => m.dates);

// ── Local UI state ────────────────────────────────────────────────────────────
// serverState mirrors what the backend holds; myAvailability is local until submit
let serverState    = { submissions: [] };   // { submissions, schedule?, scheduleError? }
let myAvailability = new Set();
let mySubmitted    = false;

// ── Utilities ─────────────────────────────────────────────────────────────────
const esc      = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const getName  = () => document.getElementById('myname').value.trim();
const myRecord = () => serverState.submissions.find(s => s.name === getName());
const isMine   = sub => sub.name === getName();

function showToast(msg, duration = 4000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('visible');
  setTimeout(() => t.classList.remove('visible'), duration);
}

// ── API calls ─────────────────────────────────────────────────────────────────
async function apiFetch(method, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(APPS_SCRIPT_URL, opts);
  return res.json();
}

async function loadState() {
  try {
    const data = await apiFetch('GET');
    serverState = data;
  } catch(e) {
    showToast('Could not reach the server — showing local state only.');
  }
  document.getElementById('loading-bar').style.display = 'none';
  document.getElementById('main-content').style.display = 'block';
  render();
}

async function claimPaper(paperId, paperTitle) {
  const name = getName();
  if (!name) { showToast('Please enter your name first.'); return; }

  // Optimistic UI update
  serverState.submissions.push({ name, paperId, paperTitle, availability: [] });
  render();

  try {
    const data = await apiFetch('POST', { action: 'submit', name, paperId, paperTitle, availability: [] });
    if (!data.ok) {
      // Roll back
      serverState.submissions = serverState.submissions.filter(s => !(s.name === name && s.paperId === paperId));
      render();
      showToast(data.error || 'Could not claim paper — please try again.');
      return;
    }
    serverState = data.state;
    render();
  } catch(e) {
    serverState.submissions = serverState.submissions.filter(s => !(s.name === name && s.paperId === paperId));
    render();
    showToast('Network error — please try again.');
  }
}

async function releasePaper() {
  const name = getName();
  myAvailability.clear();

  // Optimistic
  serverState.submissions = serverState.submissions.filter(s => s.name !== name);
  render();

  try {
    const data = await apiFetch('POST', { action: 'release', name });
    if (data.ok) serverState = data.state;
    render();
  } catch(e) {
    showToast('Network error when releasing — please refresh.');
  }
}

async function submitAvailability() {
  const name = getName();
  const rec  = myRecord();
  if (!rec || myAvailability.size === 0) return;

  const availability = [...myAvailability];
  const btn  = document.getElementById('btn-submit');
  btn.disabled = true;
  btn.textContent = 'Submitting…';

  try {
    const data = await apiFetch('POST', {
      action: 'submit',
      name,
      paperId:    rec.paperId,
      paperTitle: rec.paperTitle,
      availability,
    });

    if (!data.ok) {
      btn.disabled = false;
      btn.innerHTML = svgArrow() + ' Submit Availability';
      showToast(data.error || 'Something went wrong — please try again.');
      return;
    }

    serverState  = data.state;
    mySubmitted  = true;
    btn.textContent = 'Submitted';
    render();
    showPostSubmitPanel();

  } catch(e) {
    btn.disabled = false;
    btn.innerHTML = svgArrow() + ' Submit Availability';
    showToast('Network error — please try again.');
  }
}

function svgArrow() {
  return '<svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M2 7h10M7 2l5 5-5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
}

// ── Rendering ─────────────────────────────────────────────────────────────────
function render() {
  const name   = getName();
  const rec    = myRecord();                          // my server record (if any)
  const list   = document.getElementById('paper-list');
  list.innerHTML = '';

  PAPERS.forEach((p, i) => {
    const serverRec  = serverState.submissions.find(s => s.paperId === p.id);
    const isMyClaim  = rec && rec.paperId === p.id;
    const isTaken    = !!serverRec;
    const canClaim   = !isTaken && name && !rec && !mySubmitted;

    const card = document.createElement('div');
    card.className = 'paper-card' + (isMyClaim ? ' claimed-mine' : isTaken ? ' claimed-other' : '');
    card.style.animationDelay = (i * 0.04) + 's';

    const bar = document.createElement('div');
    bar.className = 'paper-card-bar';
    card.appendChild(bar);

    const inner = document.createElement('div');
    inner.className = 'paper-inner';

    const left = document.createElement('div');
    left.innerHTML = `<div class="paper-title">${esc(p.title)}</div><div class="paper-tag">${esc(p.tag)}</div>`;

    const presEl = document.createElement('div');
    presEl.className = 'paper-presenter' + (isTaken ? '' : ' empty');
    presEl.textContent = isTaken ? serverRec.name : 'unclaimed';
    left.appendChild(presEl);

    const actions = document.createElement('div');
    actions.className = 'paper-actions';

    if (isMyClaim && !mySubmitted) {
      const btnR = document.createElement('button');
      btnR.className = 'btn-release';
      btnR.textContent = 'Release';
      btnR.onclick = releasePaper;
      actions.appendChild(btnR);
    } else if (canClaim) {
      const btnC = document.createElement('button');
      btnC.className = 'btn-claim';
      btnC.textContent = 'Claim';
      btnC.onclick = () => claimPaper(p.id, p.title);
      actions.appendChild(btnC);
    }

    inner.appendChild(left);
    inner.appendChild(actions);
    card.appendChild(inner);

    // Availability picker — only for my claimed paper, before submit
    if (isMyClaim && !mySubmitted) {
      const avail = document.createElement('div');
      avail.className = 'avail-section open';

      const lbl = document.createElement('div');
      lbl.className = 'avail-label';
      lbl.textContent = 'Mark every Monday you are available to present';
      avail.appendChild(lbl);

      const monthsWrap = document.createElement('div');
      monthsWrap.className = 'avail-months';

      MONTHS.forEach(m => {
        const mg = document.createElement('div');
        mg.className = 'avail-month';
        const mn = document.createElement('div');
        mn.className = 'month-name';
        mn.textContent = m.label;
        mg.appendChild(mn);
        const chipsWrap = document.createElement('div');
        chipsWrap.className = 'date-chips';
        m.dates.forEach(d => {
          const chip = document.createElement('div');
          chip.className = 'date-chip' + (myAvailability.has(d) ? ' on' : '');
          chip.textContent = d;
          chip.onclick = () => {
            if (myAvailability.has(d)) myAvailability.delete(d);
            else myAvailability.add(d);
            chip.classList.toggle('on');
            updateCounter(p.id);
            updateSubmitBtn();
          };
          chipsWrap.appendChild(chip);
        });
        mg.appendChild(chipsWrap);
        monthsWrap.appendChild(mg);
      });

      avail.appendChild(monthsWrap);

      const counter = document.createElement('div');
      counter.className = 'avail-counter';
      counter.id = 'avail-counter-' + p.id;
      const n = myAvailability.size;
      counter.innerHTML = `<span>${n}</span> date${n !== 1 ? 's' : ''} selected`;
      avail.appendChild(counter);

      card.appendChild(avail);
    }

    list.appendChild(card);
  });

  updateProgress();
  updateSubmitBtn();

  // If schedule already exists (e.g. page loaded after all submitted), show it
  if (serverState.schedule) showSchedule();
  else if (serverState.scheduleError) document.getElementById('panel-error').style.display = 'block';
}

function updateCounter(paperId) {
  const el = document.getElementById('avail-counter-' + paperId);
  if (!el) return;
  const n = myAvailability.size;
  el.innerHTML = `<span>${n}</span> date${n !== 1 ? 's' : ''} selected`;
}

function updateProgress() {
  const n = serverState.submissions.length;
  document.getElementById('progress-count').textContent = n + ' / 10';
  document.getElementById('progress-fill').style.width  = (n * 10) + '%';
}

function updateSubmitBtn() {
  const rec  = myRecord();
  const btn  = document.getElementById('btn-submit');
  const note = document.getElementById('submit-note');

  if (mySubmitted) {
    btn.disabled     = true;
    note.textContent = 'Your availability has been recorded.';
    return;
  }
  if (!rec) {
    btn.disabled     = true;
    note.textContent = getName() ? 'Claim a paper to continue.' : 'Enter your name to get started.';
    return;
  }
  const n = myAvailability.size;
  if (n === 0) {
    btn.disabled     = true;
    note.textContent = 'Mark at least one available date to proceed.';
    return;
  }
  btn.disabled     = false;
  note.textContent = `Ready — ${n} date${n !== 1 ? 's' : ''} selected.`;
}

function showPostSubmitPanel() {
  if (serverState.schedule) {
    showSchedule();
  } else if (serverState.scheduleError) {
    document.getElementById('panel-error').style.display = 'block';
    document.getElementById('panel-error').scrollIntoView({ behavior: 'smooth', block: 'start' });
  } else {
    const wp = document.getElementById('panel-waiting');
    wp.style.display = 'block';
    wp.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function showSchedule() {
  const panel  = document.getElementById('panel-schedule');
  const rowsEl = document.getElementById('schedule-rows');
  rowsEl.innerHTML = '';

  const sched = serverState.schedule;

  [...serverState.submissions]
    .sort((a, b) => ALL_DATES.indexOf(sched[a.paperId]) - ALL_DATES.indexOf(sched[b.paperId]))
    .forEach(s => {
      const row = document.createElement('div');
      row.className = 'schedule-row';
      row.innerHTML = `
        <div>
          <div class="schedule-paper-title">${esc(s.paperTitle)}</div>
          <div class="schedule-presenter">${esc(s.name)}</div>
        </div>
        <div class="schedule-date">${sched[s.paperId]}</div>`;
      rowsEl.appendChild(row);
    });

  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ── Boot ──────────────────────────────────────────────────────────────────────
document.getElementById('myname').addEventListener('input', render);
loadState();
</script>
</body>
</html>
